#!/usr/bin/env bash
# ComfyUI ç°¡åŒ–å®‰è£è…³æœ¬ - åŒ¹é…è‡‰å‹æ›è‡‰é«˜ç›¸ä¼¼åº¦å·¥ä½œæµ
# v3 - ç°¡åŒ–ç‰ˆæœ¬ï¼Œå°ˆæ³¨æ–¼å–®ä¸€å·¥ä½œæµå’Œå¿…è¦æ¨¡å‹

set -Eeuo pipefail
umask 022
export LC_ALL=C.UTF-8 LANG=C.UTF-8
trap 'echo "âŒ å¤±æ•—ï¼ˆè¡Œ $LINENOï¼‰: $BASH_COMMAND" >&2' ERR

# --- åŸºæœ¬è¨­å®š ---
COMFYUI_DIR="${COMFYUI_DIR:-/workspace/ComfyUI}"
WORKFLOWS_DIR="$COMFYUI_DIR/user/default/workflows"

# --- å‰ç½®æª¢æŸ¥ ---
if [[ ! -d "$COMFYUI_DIR" ]]; then
  echo "âŒ ComfyUI ç›®éŒ„ä¸å­˜åœ¨: $COMFYUI_DIR"
  echo "è«‹å…ˆå®‰è£ ComfyUI æˆ–æª¢æŸ¥è·¯å¾‘æ˜¯å¦æ­£ç¢º"
  exit 1
fi

# æ‰¾åˆ° python èˆ‡ pip
PY="$(command -v python3 || true)"
[[ -z "${PY}" ]] && PY="$(command -v python || true)"
if [[ -z "${PY}" ]]; then
  echo "âŒ æ‰¾ä¸åˆ° python3/pythonï¼Œè«‹å…ˆå®‰è£ Pythonã€‚"
  exit 1
fi
PIP="$PY -m pip"

# ç¢ºä¿å¿…è¦å·¥å…·å¯ç”¨
ensure_tool() {
  local bin="$1"
  if ! command -v "$bin" >/dev/null 2>&1; then
    if command -v apt-get >/dev/null 2>&1; then
      echo "  ğŸ“¦ å®‰è£ $bin..."
      apt-get update -y && apt-get install -y "$bin" || true
    fi
  fi
}

echo "ğŸ“‹ [1/7] æª¢æŸ¥ä¸¦å®‰è£å¿…è¦å·¥å…·..."
ensure_tool git
ensure_tool wget
ensure_tool unzip

echo "ğŸ [2/7] å®‰è£/æ›´æ–° Python å¥—ä»¶ï¼ˆcomfy-cliï¼‰..."
$PIP install --upgrade --no-input comfy-cli
hash -r || true  # åˆ·æ–° shell command hash

# è¨­å®š comfy-cli åŸ·è¡Œæ–¹å¼
if command -v comfy >/dev/null 2>&1; then
  COMFY="comfy"
else
  COMFY="$PY -m comfy_cli"
fi

cd "$COMFYUI_DIR"
export COMFYUI_PATH="$COMFYUI_DIR"

echo "âœ… [3/7] é©—è­‰ comfy-cli å¯ç”¨æ€§..."
$COMFY --version >/dev/null 2>&1 || $COMFY --help >/dev/null

echo "ğŸ“¥ [4/7] ä¸‹è¼‰ä¸¦å®‰è£å·¥ä½œæµ..."
mkdir -p "$WORKFLOWS_DIR"

# ä¸‹è¼‰æ–°å·¥ä½œæµ
WORKFLOW_URL="https://raw.githubusercontent.com/yetrtyog-creator/Automation_script_used_by_Chuangchao_Company/main/%E5%8C%B9%E9%85%8D%E8%84%B8%E5%9E%8B%E6%8D%A2%E8%84%B8%E9%AB%98%E7%9B%B8%E4%BC%BC%E5%BA%A6_%E6%94%B9%E9%81%8E.json"
WORKFLOW_DST="$WORKFLOWS_DIR/face-matching-high-similarity.json"

echo "  ğŸ“„ ä¸‹è¼‰å·¥ä½œæµ..."
if wget -q -O "$WORKFLOW_DST" "$WORKFLOW_URL"; then
  echo "  âœ… å·¥ä½œæµä¸‹è¼‰å®Œæˆ: $WORKFLOW_DST"
else
  echo "  âŒ å·¥ä½œæµä¸‹è¼‰å¤±æ•—"
  exit 1
fi

echo "ğŸ”§ [5/7] å®‰è£å·¥ä½œæµä¾è³´ç¯€é»ï¼ˆcomfy-cliï¼‰..."
install_deps() {
  local wf="$1"
  [[ -f "$wf" ]] || { echo "  âŒ æ‰¾ä¸åˆ°å·¥ä½œæµï¼š$wf"; return 1; }

  # ä¿è­‰åœ¨ ComfyUI æ ¹ç›®éŒ„åŸ·è¡Œ
  ( cd "$COMFYUI_DIR" || exit 1

    local tries=3
    local rc=0

    for ((i=1; i<=tries; i++)); do
      echo "  ğŸ”„ å®‰è£ä¾è³´å˜—è©¦ $i/$tries"
      echo "     -> $COMFY --here node install-deps --workflow '$wf'"

      # æ–¹æ¡ˆ Aï¼šæœ€æ–° comfy-cliï¼ˆæœ‰ --hereï¼‰
      $COMFY --here node install-deps --workflow "$wf" </dev/null && { echo "  âœ… ä¾è³´å®‰è£æˆåŠŸ"; return 0; }
      rc=$?
      echo "     âŒ æ–¹æ¡ˆAå¤±æ•— (rc=$rc)"

      # æ–¹æ¡ˆ Bï¼šæ²’æœ‰ --here
      echo "     -> $COMFY node install-deps --workflow '$wf'"
      $COMFY node install-deps --workflow "$wf" </dev/null && { echo "  âœ… ä¾è³´å®‰è£æˆåŠŸ"; return 0; }
      rc=$?
      echo "     âŒ æ–¹æ¡ˆBå¤±æ•— (rc=$rc)"

      # æ–¹æ¡ˆ Cï¼šæœ‰äº›ç‰ˆæœ¬éœ€è¦ -y/--yes
      echo "     -> $COMFY node install-deps --workflow '$wf' -y"
      $COMFY node install-deps --workflow "$wf" -y </dev/null && { echo "  âœ… ä¾è³´å®‰è£æˆåŠŸ"; return 0; }
      rc=$?
      echo "     âŒ æ–¹æ¡ˆCå¤±æ•— (rc=$rc)"

      sleep 2
    done

    echo "  âŒ ä¾è³´å®‰è£é€£çºŒå¤±æ•— $tries æ¬¡ï¼Œåœæ­¢ã€‚"
    exit 1
  )
}

echo "ğŸ’¾ [6/7] ä¸‹è¼‰ä¸¦å®‰è£å¿…è¦æ¨¡å‹..."

# å»ºç«‹æ‰€éœ€çš„æ¨¡å‹ç›®éŒ„
CHECKPOINTS_DIR="$COMFYUI_DIR/models/checkpoints"
INSTANTID_DIR="$COMFYUI_DIR/models/instantid"
CONTROLNET_DIR="$COMFYUI_DIR/models/controlnet"
ULTRALYTICS_DIR="$COMFYUI_DIR/models/ultralytics/bbox"
LANDMARKS_DIR="$COMFYUI_DIR/models/landmarks"
INSIGHTFACE_DIR="$COMFYUI_DIR/models/insightface/models"

mkdir -p "$CHECKPOINTS_DIR" "$INSTANTID_DIR" "$CONTROLNET_DIR" \
         "$ULTRALYTICS_DIR" "$LANDMARKS_DIR" "$INSIGHTFACE_DIR"

# ä¸‹è¼‰æ¨¡å‹çš„é€šç”¨å‡½æ•¸
download_model() {
  local url="$1"
  local dest_dir="$2"
  local filename="$3"
  local display_name="$4"
  
  echo "  ğŸ“¦ ä¸‹è¼‰ $display_name..."
  local dest_path="$dest_dir/$filename"
  
  # å¦‚æœæª”æ¡ˆå·²å­˜åœ¨ï¼Œè·³éä¸‹è¼‰
  if [[ -f "$dest_path" ]]; then
    echo "    âœ… å·²å­˜åœ¨ï¼Œè·³éä¸‹è¼‰"
    return 0
  fi
  
  if wget -q --show-progress -O "$dest_path" "$url"; then
    echo "    âœ… ä¸‹è¼‰å®Œæˆ: $filename"
  else
    echo "    âŒ ä¸‹è¼‰å¤±æ•—: $display_name"
    rm -f "$dest_path"  # æ¸…ç†å¤±æ•—çš„éƒ¨åˆ†ä¸‹è¼‰
    return 1
  fi
}

# ä¸‹è¼‰å„å€‹æ¨¡å‹
echo "  ğŸ“‚ ä¸‹è¼‰ Checkpoint æ¨¡å‹..."
download_model \
  "https://huggingface.co/gingerlollipopdx/ModelsXL/resolve/main/dreamshaperXL_v21TurboDPMSDE.safetensors" \
  "$CHECKPOINTS_DIR" \
  "dreamshaperXL_v21TurboDPMSDE.safetensors" \
  "DreamShaper XL v21"

download_model \
  "https://huggingface.co/lllyasviel/flux1_dev/resolve/main/flux1-dev-fp8.safetensors" \
  "$CHECKPOINTS_DIR" \
  "flux1-dev-fp8.safetensors" \
  "FLUX.1 Dev FP8"

echo "  ğŸ“‚ ä¸‹è¼‰ InstantID æ¨¡å‹..."
download_model \
  "https://huggingface.co/InstantX/InstantID/resolve/main/ip-adapter.bin" \
  "$INSTANTID_DIR" \
  "ip-adapter.bin" \
  "InstantID IP-Adapter"

echo "  ğŸ“‚ ä¸‹è¼‰ ControlNet æ¨¡å‹..."
download_model \
  "https://huggingface.co/InstantX/InstantID/resolve/main/ControlNetModel/diffusion_pytorch_model.safetensors" \
  "$CONTROLNET_DIR" \
  "diffusion_pytorch_model.safetensors" \
  "InstantID ControlNet"

echo "  ğŸ“‚ ä¸‹è¼‰ YOLOv8 æ¨¡å‹..."
download_model \
  "https://huggingface.co/Bingsu/adetailer/resolve/main/face_yolov8m.pt" \
  "$ULTRALYTICS_DIR" \
  "face_yolov8m.pt" \
  "Face YOLOv8m"

echo "  ğŸ“‚ ä¸‹è¼‰ Landmark æ¨¡å‹..."
download_model \
  "https://huggingface.co/goktuggumus/weights/resolve/cc6d47a6722496ee085e845b36d7bbd911597964/landmarks/fan2_68_landmark.onnx" \
  "$LANDMARKS_DIR" \
  "fan2_68_landmark.onnx" \
  "FAN2 68 Landmark"

echo "ğŸ¦Œ [7/7] å®‰è£ AntelopeV2 æ¨¡å‹..."
(
  cd "$INSIGHTFACE_DIR"
  # æ¸…ç†èˆŠç‰ˆæœ¬
  rm -rf antelopev2 antelopev2.zip
  
  echo "  ğŸ“¥ ä¸‹è¼‰ AntelopeV2..."
  if wget -q --show-progress -O antelopev2.zip \
      "https://github.com/deepinsight/insightface/releases/download/v0.7/antelopev2.zip"; then
    echo "  ğŸ“¦ è§£å£“ç¸® AntelopeV2..."
    unzip -o antelopev2.zip
    rm -f antelopev2.zip
    echo "  âœ… AntelopeV2 å®‰è£å®Œæˆ"
  else
    echo "  âŒ AntelopeV2 ä¸‹è¼‰å¤±æ•—"
  fi
)

echo
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ‰ å®‰è£å®Œæˆï¼"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo
echo "ğŸ“‹ å·²å®‰è£é …ç›®æ‘˜è¦ï¼š"
echo
echo "ğŸ“„ å·¥ä½œæµï¼š"
echo "   â””â”€â”€ $WORKFLOW_DST"
echo
echo "ğŸ’¾ æ¨¡å‹ï¼š"
echo "   â”œâ”€â”€ Checkpoints:"
echo "   â”‚   â”œâ”€â”€ dreamshaperXL_v21TurboDPMSDE.safetensors"
echo "   â”‚   â””â”€â”€ flux1-dev-fp8.safetensors"
echo "   â”œâ”€â”€ InstantID:"
echo "   â”‚   â””â”€â”€ ip-adapter.bin"
echo "   â”œâ”€â”€ ControlNet:"
echo "   â”‚   â””â”€â”€ diffusion_pytorch_model.safetensors"
echo "   â”œâ”€â”€ Ultralytics:"
echo "   â”‚   â””â”€â”€ face_yolov8m.pt"
echo "   â”œâ”€â”€ Landmarks:"
echo "   â”‚   â””â”€â”€ fan2_68_landmark.onnx"
echo "   â””â”€â”€ InsightFace:"
echo "       â””â”€â”€ antelopev2/"
echo
echo "ğŸš€ å•Ÿå‹• ComfyUIï¼š"
echo "   $COMFY --here launch"
echo
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"\n'; then
      echo "  âœ… ä¾è³´å®‰è£æˆåŠŸ"
      return 0
    fi
    sleep 2
  done
  echo "  âš ï¸ ä¾è³´å®‰è£å¤±æ•—ï¼ˆå°‡ç¹¼çºŒåŸ·è¡Œï¼‰"
  return 0  # ä¸ä¸­æ–·è…³æœ¬
}

install_deps "$WORKFLOW_DST"

# å®‰è£ sunxAI_facetools ç¯€é»
echo "  ğŸ“¦ å®‰è£ sunxAI_facetools ç¯€é»..."
CUSTOM_NODES_DIR="$COMFYUI_DIR/custom_nodes"
if [[ ! -d "$CUSTOM_NODES_DIR/comfyui_sunxAI_facetools" ]]; then
  echo "    ğŸ”„ å¾ GitHub å…‹éš†ç¯€é»..."
  git clone https://github.com/upseem/comfyui_sunxAI_facetools.git "$CUSTOM_NODES_DIR/comfyui_sunxAI_facetools"
  
  # å¦‚æœç¯€é»æœ‰ requirements.txtï¼Œå®‰è£ä¾è³´
  if [[ -f "$CUSTOM_NODES_DIR/comfyui_sunxAI_facetools/requirements.txt" ]]; then
    echo "    ğŸ“¦ å®‰è£ç¯€é» Python ä¾è³´..."
    $PIP install -r "$CUSTOM_NODES_DIR/comfyui_sunxAI_facetools/requirements.txt"
  fi
  echo "    âœ… sunxAI_facetools ç¯€é»å®‰è£å®Œæˆ"
else
  echo "    âœ… sunxAI_facetools ç¯€é»å·²å­˜åœ¨"
fi

# å˜—è©¦æ›´æ–°æ‰€æœ‰ç¯€é»
echo "  ğŸ”„ æ›´æ–°æ‰€æœ‰ç¯€é»..."
$COMFY --here node update all || echo "  âš ï¸ ç¯€é»æ›´æ–°å¤±æ•—ï¼ˆå¿½ç•¥ï¼‰"

echo "ğŸ’¾ [6/7] ä¸‹è¼‰ä¸¦å®‰è£å¿…è¦æ¨¡å‹..."

# å»ºç«‹æ‰€éœ€çš„æ¨¡å‹ç›®éŒ„
CHECKPOINTS_DIR="$COMFYUI_DIR/models/checkpoints"
INSTANTID_DIR="$COMFYUI_DIR/models/instantid"
CONTROLNET_DIR="$COMFYUI_DIR/models/controlnet"
ULTRALYTICS_DIR="$COMFYUI_DIR/models/ultralytics/bbox"
LANDMARKS_DIR="$COMFYUI_DIR/models/landmarks"
INSIGHTFACE_DIR="$COMFYUI_DIR/models/insightface/models"

mkdir -p "$CHECKPOINTS_DIR" "$INSTANTID_DIR" "$CONTROLNET_DIR" \
         "$ULTRALYTICS_DIR" "$LANDMARKS_DIR" "$INSIGHTFACE_DIR"

# ä¸‹è¼‰æ¨¡å‹çš„é€šç”¨å‡½æ•¸
download_model() {
  local url="$1"
  local dest_dir="$2"
  local filename="$3"
  local display_name="$4"
  
  echo "  ğŸ“¦ ä¸‹è¼‰ $display_name..."
  local dest_path="$dest_dir/$filename"
  
  # å¦‚æœæª”æ¡ˆå·²å­˜åœ¨ï¼Œè·³éä¸‹è¼‰
  if [[ -f "$dest_path" ]]; then
    echo "    âœ… å·²å­˜åœ¨ï¼Œè·³éä¸‹è¼‰"
    return 0
  fi
  
  if wget -q --show-progress -O "$dest_path" "$url"; then
    echo "    âœ… ä¸‹è¼‰å®Œæˆ: $filename"
  else
    echo "    âŒ ä¸‹è¼‰å¤±æ•—: $display_name"
    rm -f "$dest_path"  # æ¸…ç†å¤±æ•—çš„éƒ¨åˆ†ä¸‹è¼‰
    return 1
  fi
}

# ä¸‹è¼‰å„å€‹æ¨¡å‹
echo "  ğŸ“‚ ä¸‹è¼‰ Checkpoint æ¨¡å‹..."
download_model \
  "https://huggingface.co/gingerlollipopdx/ModelsXL/resolve/main/dreamshaperXL_v21TurboDPMSDE.safetensors" \
  "$CHECKPOINTS_DIR" \
  "dreamshaperXL_v21TurboDPMSDE.safetensors" \
  "DreamShaper XL v21"

download_model \
  "https://huggingface.co/lllyasviel/flux1_dev/resolve/main/flux1-dev-fp8.safetensors" \
  "$CHECKPOINTS_DIR" \
  "flux1-dev-fp8.safetensors" \
  "FLUX.1 Dev FP8"

echo "  ğŸ“‚ ä¸‹è¼‰ InstantID æ¨¡å‹..."
download_model \
  "https://huggingface.co/InstantX/InstantID/resolve/main/ip-adapter.bin" \
  "$INSTANTID_DIR" \
  "ip-adapter.bin" \
  "InstantID IP-Adapter"

echo "  ğŸ“‚ ä¸‹è¼‰ ControlNet æ¨¡å‹..."
download_model \
  "https://huggingface.co/InstantX/InstantID/resolve/main/ControlNetModel/diffusion_pytorch_model.safetensors" \
  "$CONTROLNET_DIR" \
  "diffusion_pytorch_model.safetensors" \
  "InstantID ControlNet"

echo "  ğŸ“‚ ä¸‹è¼‰ YOLOv8 æ¨¡å‹..."
download_model \
  "https://huggingface.co/Bingsu/adetailer/resolve/main/face_yolov8m.pt" \
  "$ULTRALYTICS_DIR" \
  "face_yolov8m.pt" \
  "Face YOLOv8m"

echo "  ğŸ“‚ ä¸‹è¼‰ Landmark æ¨¡å‹..."
download_model \
  "https://huggingface.co/goktuggumus/weights/resolve/cc6d47a6722496ee085e845b36d7bbd911597964/landmarks/fan2_68_landmark.onnx" \
  "$LANDMARKS_DIR" \
  "fan2_68_landmark.onnx" \
  "FAN2 68 Landmark"

echo "ğŸ¦Œ [7/7] å®‰è£ AntelopeV2 æ¨¡å‹..."
(
  cd "$INSIGHTFACE_DIR"
  # æ¸…ç†èˆŠç‰ˆæœ¬
  rm -rf antelopev2 antelopev2.zip
  
  echo "  ğŸ“¥ ä¸‹è¼‰ AntelopeV2..."
  if wget -q --show-progress -O antelopev2.zip \
      "https://github.com/deepinsight/insightface/releases/download/v0.7/antelopev2.zip"; then
    echo "  ğŸ“¦ è§£å£“ç¸® AntelopeV2..."
    unzip -o antelopev2.zip
    rm -f antelopev2.zip
    echo "  âœ… AntelopeV2 å®‰è£å®Œæˆ"
  else
    echo "  âŒ AntelopeV2 ä¸‹è¼‰å¤±æ•—"
  fi
)

echo
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ‰ å®‰è£å®Œæˆï¼"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo
echo "ğŸ“‹ å·²å®‰è£é …ç›®æ‘˜è¦ï¼š"
echo
echo "ğŸ“„ å·¥ä½œæµï¼š"
echo "   â””â”€â”€ $WORKFLOW_DST"
echo
echo "ğŸ’¾ æ¨¡å‹ï¼š"
echo "   â”œâ”€â”€ Checkpoints:"
echo "   â”‚   â”œâ”€â”€ dreamshaperXL_v21TurboDPMSDE.safetensors"
echo "   â”‚   â””â”€â”€ flux1-dev-fp8.safetensors"
echo "   â”œâ”€â”€ InstantID:"
echo "   â”‚   â””â”€â”€ ip-adapter.bin"
echo "   â”œâ”€â”€ ControlNet:"
echo "   â”‚   â””â”€â”€ diffusion_pytorch_model.safetensors"
echo "   â”œâ”€â”€ Ultralytics:"
echo "   â”‚   â””â”€â”€ face_yolov8m.pt"
echo "   â”œâ”€â”€ Landmarks:"
echo "   â”‚   â””â”€â”€ fan2_68_landmark.onnx"
echo "   â””â”€â”€ InsightFace:"
echo "       â””â”€â”€ antelopev2/"
echo
echo "ğŸš€ å•Ÿå‹• ComfyUIï¼š"
echo "   $COMFY --here launch"
echo
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
